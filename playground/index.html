<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ENG Playground</title>

<!-- Prism theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
<link rel="stylesheet" href="../css/theme.css">
</head>
<body>

<h1>ENG Playground</h1>

<div class="toolbar">
  <button id="runButton">Run</button>
  <button id="clearButton">Clear</button>
  <button id="copyOutput">Copy Output</button>
</div>

<div class="zoom-control">
  <button id="zoomOut">A-</button>
  <span id="fontSizeDisplay">16px</span>
  <button id="zoomIn">A+</button>
</div>

<div class="container">
  <!-- Editor -->
  <div id="editorWrapper" class="pane">
    <textarea id="editorInput" spellcheck="false"></textarea>
    <pre><code id="editorHighlight" class="language-eng"></code></pre>
    <div id="autocomplete"></div>
  </div>

  <!-- Output -->
  <div id="outputWrapper" class="pane">
    <pre id="output"></pre>
  </div>
</div>

<footer>ENG Playground © 2025</footer>

<!-- Prism -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script>
Prism.languages.eng = {
  'comment': /#.*$/m,
  'string': /(["'])(?:(?=(\\?))\2.)*?\1/,
  'keyword': /\b(?:let|set|say|input|repeat|while|break|continue|function|class|return|true|false)\b/,
  'number': /\b\d+(?:\.\d+)?\b/,
  'operator': /[+\-*\/=]/,
  'punctuation': /[()[\]{}:,]/
};

const editorInput = document.getElementById('editorInput');
const editorHighlight = document.getElementById('editorHighlight');
const output = document.getElementById('output');
const fontSizeDisplay = document.getElementById('fontSizeDisplay');
const autocomplete = document.getElementById('autocomplete');

let codeSize = 16;

function applyFontSize() {
  document.documentElement.style.setProperty('--code-size', codeSize + 'px');
  fontSizeDisplay.textContent = codeSize + 'px';
}

document.getElementById('zoomIn').addEventListener('click', () => {
  codeSize = Math.min(50, codeSize + 2);
  applyFontSize();
});
document.getElementById('zoomOut').addEventListener('click', () => {
  codeSize = Math.max(10, codeSize - 2);
  applyFontSize();
});
document.getElementById('copyOutput').addEventListener('click', () => {
  navigator.clipboard.writeText(output.innerText || '');
});

// Live syntax highlight
function updateHighlight() {
  editorHighlight.textContent = editorInput.value;
  Prism.highlightElement(editorHighlight);
}
editorInput.addEventListener('input', () => {
  updateHighlight();
  updateAutocomplete();
});

// Initial text
editorInput.value = `# Welcome to ENG programming
say "Hello, World!"
let x = 10
class Demo:
  function greet():
    say "Hi!"
`;
updateHighlight();
applyFontSize();

/* === Autocomplete System === */
const keywords = [
  "break", "class", "continue", "false", "function", "input", 
  "let", "repeat", "return", "say", "set", "true", "while"
];

let variables = new Set();
let classes = new Set();
let methods = new Set();

function updateAutocomplete() {
  const text = editorInput.value;
  const cursorPos = editorInput.selectionStart;
  const prefix = getCurrentWord(text, cursorPos);

  // Extract variables and classes
  variables = new Set((text.match(/\blet\s+(\w+)/g) || []).map(m => m.split(" ")[1]));
  classes = new Set((text.match(/\bclass\s+(\w+)/g) || []).map(m => m.split(" ")[1]));
  methods = new Set((text.match(/\bfunction\s+(\w+)/g) || []).map(m => m.split(" ")[1]));

  let suggestions = [];

  keywords.forEach(k => suggestions.push({ type: "keyword", word: k }));
  variables.forEach(v => suggestions.push({ type: "variable", word: v }));
  classes.forEach(c => suggestions.push({ type: "class", word: c }));
  methods.forEach(m => suggestions.push({ type: "method", word: m }));

  suggestions = suggestions
    .filter(s => s.word.startsWith(prefix))
    .sort((a, b) => a.word.localeCompare(b.word));

  if (prefix && suggestions.length > 0) {
    autocomplete.innerHTML = "";
    suggestions.forEach(s => {
      const div = document.createElement("div");
      const icon = document.createElement("span");
      icon.className = "symbol " + s.type;
      icon.textContent = {
        keyword: "📘",
        variable: "🔤",
        class: "🏛️",
        method: "⚙️"
      }[s.type];
      const textNode = document.createElement("span");
      textNode.textContent = s.word;
      div.appendChild(icon);
      div.appendChild(textNode);

      div.onclick = () => insertAutocomplete(s.word, cursorPos, prefix);
      autocomplete.appendChild(div);
    });
    autocomplete.style.display = "block";
    autocomplete.style.left = "10px";
    autocomplete.style.top = "40px";
  } else {
    autocomplete.style.display = "none";
  }
}

function getCurrentWord(text, pos) {
  let start = pos;
  while (start > 0 && /\w/.test(text[start - 1])) start--;
  return text.slice(start, pos);
}

function insertAutocomplete(word, cursorPos, prefix) {
  const text = editorInput.value;
  const start = cursorPos - prefix.length;
  const newText = text.slice(0, start) + word + text.slice(cursorPos);
  editorInput.value = newText;
  editorInput.selectionStart = editorInput.selectionEnd = start + word.length;
  updateHighlight();
  autocomplete.style.display = "none";
}
</script>

<script src="interpreter.js"></script>
</body>
</html>
